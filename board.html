<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>éå»å•æ²ç¤ºæ¿ & AIè§£èª¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="/img/favicon-16.ico" sizes="16x16" type="image/iso">
  <link rel="icon" href="/img/favicon-32.ico" sizes="32x32" type="image/iso">
  <link rel="icon" href="/img/favicon-48.ico" sizes="48x48" type="image/iso">
  <link rel="icon" href="/img/favicon-128.ico" sizes="128x128" type="image/iso">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon-180.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://cdn.jsdelivr.net/npm/@google/generative-ai@0.21.0/+esm"
      }
    }
  </script>

  <style>
    .ai-comment {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 5;
      overflow: hidden;
      transition: 0.3s;
    }
    .ai-comment.open { -webkit-line-clamp: unset; }
    .toggle-btn {
      display: block;
      margin: 5px 0 15px 0;
      background: none;
      border: none;
      color: #20b2aa;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 0;
    }
    .toggle-btn:hover { text-decoration: underline; }

    
    body { background-color: #7fffd4; min-height: 100vh; margin: 0; font-family: 'Noto Sans JP', sans-serif; padding-bottom: 80px; display: none; }
    .site-header { position: fixed; top: 0; left: 0; right: 0; background: #fff; height: 80px; z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .site-header img { height: auto; max-height: 50px; width: auto; display: block; }
    .header-buttons { display: flex; gap: 15px; }
    .header-btn { display: inline-flex; align-items: center; justify-content: center; background-color: #f5deb3; color: #fff; width: 90px; height: 44px; font-size: 15px; font-weight: bold; border-radius: 6px; text-decoration: none; border:none; }
    @media (max-width: 768px) {
      .site-header { height: auto; padding: 10px 0; flex-direction: column; }
      .site-header img { margin-bottom: 10px; max-width: 80%; }
      .header-buttons { width: 100%; justify-content: center; flex-wrap: wrap; gap: 8px; }
      .header-btn { width: auto; padding: 0 12px; font-size: 13px; height: 38px; }
      main { margin-top: 140px !important; }
    }
    main { width: 95%; max-width: 800px; margin: 120px auto 50px; text-align: center; }
    .tab-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .tab-btn { padding: 12px 30px; background: rgba(255,255,255,0.6); border: none; border-radius: 30px; font-weight: bold; color: #555; cursor: pointer; transition: 0.3s; font-size: 1rem; }
    .tab-btn.active { background: #fff; color: #20b2aa; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: scale(1.05); }
    .content-area { display: none; background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: left; }
    .content-area.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    h1 { text-align: center; margin: 0 0 10px 0; color: #20b2aa; font-size: 1.5rem; }
    .sub-title { text-align: center; margin: 0 0 30px 0; color: #888; font-size: 0.9rem; }
    .post-card { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .post-meta { font-size: 0.75rem; color: #999; margin-bottom: 8px; display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
    .post-text { font-size: 0.95rem; line-height: 1.6; color: #333; white-space: pre-wrap; }
    .upload-zone { border: 3px dashed #ccc; border-radius: 15px; padding: 40px 20px; text-align: center; cursor: pointer; transition: 0.3s; background: #fafafa; margin-bottom: 20px; }
    .upload-zone:hover { border-color: #20b2aa; background: #e0f7fa; }
    .upload-icon { font-size: 3rem; color: #ccc; display: block; margin-bottom: 10px; }
    #preview-img { max-width: 100%; max-height: 300px; display: none; margin: 20px auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .ai-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s; display: none; margin: 0 auto; }
    .ai-btn:hover { transform: translateY(-3px); }
    #ai-result-area { display: none; margin-top: 30px; padding: 20px; background: #fff; border: 2px solid #764ba2; border-radius: 15px; }
    .pdf-content { padding: 20px; font-family: serif; }
    .pdf-content h3 { border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 30px; }
    .action-row { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    .action-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
    .btn-pdf { background: #ff6b6b; color: white; }
    .btn-post-exam { background: #20b2aa; color: white; }
    .input-area { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; }
    #msg-input { flex: 1; max-width: 600px; padding: 12px; border: 1px solid #ccc; border-radius: 25px; outline: none; }
    #send-btn { background: #20b2aa; color: white; border: none; padding: 0 25px; border-radius: 25px; font-weight: bold; cursor: pointer; }
    .hidden { display: none !important; }
    .back-btn { display: inline-block; margin-top: 30px; padding: 12px 40px; background: #fff; color: #666; border: 2px solid #ddd; text-decoration: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .back-btn:hover { background: #666; color: #fff; border-color: #666; }
    .error-box { color: red; font-weight: bold; padding: 20px; border: 2px solid red; background: #ffebeb; border-radius: 10px; margin: 20px 0; text-align: left; }
  </style>
</head>
    
<body>
  <header class="site-header">
    <a href="index.html"><img src="img/header.png" alt="ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ"></a>
    <div class="header-buttons">
      <a href="howtouse.html" class="header-btn">ä½¿ã„æ–¹</a>
      <a href="introduction.html" class="header-btn">è£½ä½œè€…</a>
      <button id="btn-logout" class="header-btn" style="background:#ff6b6b; cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>     

  <main>
    <h1 id="page-title">å­¦æ ¡å èª­ã¿è¾¼ã¿ä¸­...</h1>
    <p class="sub-title" id="page-dept">èª­ã¿è¾¼ã¿ä¸­...</p>

    <div class="tab-container">
      <button class="tab-btn active" id="tab-text">ğŸ’¬ é›‘è«‡æ²ç¤ºæ¿</button>
      <button class="tab-btn" id="tab-exam">ğŸ“· éå»å•AIé“å ´</button>
    </div>

    <div id="area-text" class="content-area active">
      <div id="posts-container">
        <p style="text-align:center; color:#aaa;">èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>

    <div id="area-exam" class="content-area">
      <div style="text-align:center; margin-bottom:20px;">
        <p>éå»å•ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€<br><strong>AIãŒè§£èª¬ã¨é¡é¡Œãƒ—ãƒªãƒ³ãƒˆã‚’ä½œæˆ</strong>ã—ã¾ã™ï¼</p>
      </div>
      <div class="upload-zone" id="upload-zone">
        <span class="upload-icon">ğŸ“‚</span>
        <p>ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
        <input type="file" id="file-input" accept="image/*" style="display:none;">
      </div>
      <img id="preview-img" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
      
      <button id="btn-analyze" class="ai-btn">âœ¨ AIã§è§£èª¬ãƒ»é¡é¡Œã‚’ä½œæˆã™ã‚‹</button>
      
      <p id="ai-loading" style="display:none; color:#764ba2; font-weight:bold;">AIãŒæ€è€ƒä¸­...ï¼ˆç´„10ç§’ãŠå¾…ã¡ãã ã•ã„ï¼‰</p>
      <div id="ai-error-msg" style="display:none;" class="error-box"></div>

      <div id="ai-result-area">
        <div id="pdf-content" class="pdf-content">
          <h2 style="text-align:center; border-bottom:3px double #333;">AIè§£èª¬ & é¡é¡Œãƒ—ãƒªãƒ³ãƒˆ</h2>
          <div style="text-align:right; font-size:0.8rem; color:#666;" id="print-date"></div>
          
          <h3>ã€è§£èª¬ã€‘</h3>
          <div id="ai-explanation" class="ai-comment"></div>
          <button id="btn-exp-toggle" class="toggle-btn" style="display:none;">ã‚‚ã£ã¨è¦‹ã‚‹ â–¼</button>
          
          <h3>ã€é¡é¡Œã€‘</h3><div id="ai-similar-problem"></div>
          
          <h3>ã€é¡é¡Œã®è§£ç­”ã€‘</h3>
          <div id="ai-similar-answer" style="transform: rotate(180deg); display:inline-block; font-size:0.8rem; color:#888;">(ç­”ãˆã¯é€†ã•ã¾ã«ãªã£ã¦ã„ã¾ã™)</div>
        </div>
        <div class="action-row">
          <button id="btn-save-pdf" class="action-btn btn-pdf">ğŸ“„ PDFã§ä¿å­˜</button>
          <button id="btn-post-exam" class="action-btn btn-post-exam">ğŸ’¬ æ²ç¤ºæ¿ã«æŠ•ç¨¿</button>
        </div>
      </div>
      <h3 style="margin-top:50px; border-left:5px solid #20b2aa; padding-left:10px;">ã¿ã‚“ãªã®AIéå»å•æŠ•ç¨¿</h3>
      
      <div id="exam-posts-container"></div>
    </div>

    <button id="btn-back" class="back-btn">æˆ»ã‚‹</button>
  </main>

  <div class="input-area" id="input-area">
    <input type="text" id="msg-input" placeholder="è³ªå•ã‚„æƒ…å ±ã‚’å…¥åŠ›..." disabled>
    <button id="send-btn" disabled>é€ä¿¡</button>
  </div>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
  import { GoogleGenerativeAI } from "@google/generative-ai";

  // AIã‚­ãƒ¼ (â€»ã“ã“ã«ã‚ãªãŸã®APIã‚­ãƒ¼ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª)
  const GEMINI_API_KEY = "AIzaSyD4R0lmu7rkg3DSMyPNneSPvSGn4NSIhsM"; 

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyD4ViHcFj-9334N1OGQR1v3dYN1RhWfzpg", 
    authDomain: "minnanokakomon-c2b7f.firebaseapp.com",
    projectId: "minnanokakomon-c2b7f",
    storageBucket: "minnanokakomon-c2b7f.firebasestorage.app",
    messagingSenderId: "387571811654",
    appId: "1:387571811654:web:688b0c4203d07f4ae61147",
    measurementId: "G-3XFHGSE7FN"
  };

  let app;
  if (!getApps().length) { app = initializeApp(firebaseConfig); } else { app = getApps()[0]; }
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // ãƒ¢ãƒ‡ãƒ«è¨­å®šï¼ˆgemini-1.5-flashã‚’ä½¿ç”¨æ¨å¥¨ â€»2.0ã¯ã¾ã ä¸å®‰å®šãªå ´åˆãŒã‚ã‚‹ãŸã‚ï¼‰
  const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
  const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

  // ç”»é¢è¡¨ç¤º
  document.body.style.display = "block";

  // --- å…±é€šæ©Ÿèƒ½ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãªã©ï¼‰ ---
  // æ²ç¤ºæ¿ç”¨ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼ˆã‚‚ã£ã¨è¦‹ã‚‹ï¼‰
  document.addEventListener('click', function(e) {
    if(e.target && e.target.classList.contains('toggle-btn')) {
      // ç›´å‰ã®è¦ç´ ãŒè§£èª¬ã‚¨ãƒªã‚¢(ai-comment)ã‹ã©ã†ã‹åˆ¤å®š
      const textDiv = e.target.previousElementSibling;
      if (textDiv && textDiv.classList.contains('ai-comment')) {
        textDiv.classList.toggle('open');
        if(textDiv.classList.contains('open')) {
          e.target.textContent = 'é–‰ã˜ã‚‹ â–²';
        } else {
          e.target.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹ â–¼';
        }
      }
    }
  });

  window.addEventListener('DOMContentLoaded', () => {
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    const backBtn = document.getElementById('btn-back');
    if(backBtn) backBtn.addEventListener('click', () => history.back());
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    const btnLogout = document.getElementById('btn-logout');
    if(btnLogout) btnLogout.addEventListener('click', async () => {
      await signOut(auth); alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"); window.location.href="index.html";
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const tabText = document.getElementById('tab-text');
    const tabExam = document.getElementById('tab-exam');
    const areaText = document.getElementById('area-text');
    const areaExam = document.getElementById('area-exam');
    const inputArea = document.getElementById('input-area');

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.content-area').forEach(a=>a.classList.remove('active'));
      if(tab==='text'){
        tabText.classList.add('active'); areaText.classList.add('active'); inputArea.classList.remove('hidden');
      } else {
        tabExam.classList.add('active'); areaExam.classList.add('active'); inputArea.classList.add('hidden');
      }
    }
    tabText.addEventListener('click', ()=>switchTab('text'));
    tabExam.addEventListener('click', ()=>switchTab('exam'));

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
    const params = new URLSearchParams(window.location.search);
    const schoolId = params.get('school');
    const deptName = params.get('dept');
    const schoolName = params.get('sname');

    if(schoolName) document.getElementById('page-title').textContent = schoolName;
    if(deptName) document.getElementById('page-dept').textContent = deptName + " æ²ç¤ºæ¿";

    // æŠ•ç¨¿èª­ã¿è¾¼ã¿ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    const q = query(collection(db,"posts"), where("schoolId","==",schoolId), where("deptName","==",deptName));
    onSnapshot(q, (snapshot) => {
      const textC = document.getElementById('posts-container');
      const examC = document.getElementById('exam-posts-container');
      textC.innerHTML = ""; examC.innerHTML = "";
      
      if(snapshot.empty) { textC.innerHTML = "<p style='color:#aaa'>ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>"; return; }

      let posts = [];
      snapshot.forEach(doc => posts.push(doc.data()));
      posts.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

      posts.forEach(data => {
        let dateStr = "æ—¥ä»˜ä¸æ˜";
        if(data.createdAt){
            const d=data.createdAt.toDate();
            dateStr=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        const isLong = (data.text.length > 100) || (data.type === 'exam_result');
        const commentClass = isLong ? 'post-text ai-comment' : 'post-text';
        // æ²ç¤ºæ¿å†…ã®æŠ•ç¨¿ã«ã‚‚ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã¤ã‘ã‚‹
        const buttonHtml = isLong ? '<button class="toggle-btn">ã‚‚ã£ã¨è¦‹ã‚‹ â–¼</button>' : '';

        const html = `
          <div class="post-card">
            <div class="post-meta"><span class="post-name">${data.userName||"åç„¡ã—"}</span><span>${dateStr}</span></div>
            <div class="${commentClass}">${escapeHtml(data.text).replace(/\n/g,'<br>')}</div>
            ${buttonHtml}
          </div>`;
          
        if(data.type==='exam_result') examC.innerHTML += html;
        else textC.innerHTML += html;
      });
    });

    // æŠ•ç¨¿é€ä¿¡æ©Ÿèƒ½
    let currentUser = null;
    const inputF = document.getElementById('msg-input');
    const sendB = document.getElementById('send-btn');
    onAuthStateChanged(auth, (u) => {
      currentUser = u;
      if(u) { inputF.disabled=false; sendB.disabled=false; inputF.placeholder="è³ªå•ã‚’å…¥åŠ›..."; }
      else { inputF.disabled=true; sendB.disabled=true; inputF.placeholder="ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"; }
    });

    sendB.addEventListener('click', async()=>{
      const txt = inputF.value.trim();
      if(!txt || !currentUser) return;
      await addDoc(collection(db,"posts"), {
        schoolId, deptName, text:txt, type:'text', userId:currentUser.uid, userName:currentUser.displayName||"ã‚²ã‚¹ãƒˆ", createdAt:serverTimestamp()
      });
      inputF.value="";
    });

    // ==========================================
    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰AIæ©Ÿèƒ½ã®ä¿®æ­£ç‰ˆ â˜…â˜…â˜…
    // ==========================================
    const upZone = document.getElementById('upload-zone');
    const fileIn = document.getElementById('file-input');
    const prevImg = document.getElementById('preview-img');
    const aiBtn = document.getElementById('btn-analyze');
    const loadingEl = document.getElementById('ai-loading');
    const errorEl = document.getElementById('ai-error-msg');
    let selFile = null;

    upZone.addEventListener('click', ()=>fileIn.click());
    fileIn.addEventListener('change', (e)=>{
      if(e.target.files.length>0) {
        selFile = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
          prevImg.src = ev.target.result;
          prevImg.style.display = 'block';
          aiBtn.style.display = 'block';
          upZone.style.display = 'none';
          errorEl.style.display = 'none';
        };
        reader.readAsDataURL(selFile);
      }
    });

    aiBtn.addEventListener('click', async()=>{
      if(!selFile) return;
      
      // UIãƒªã‚»ãƒƒãƒˆ
      loadingEl.style.display = 'block';
      aiBtn.style.display = 'none';
      errorEl.style.display = 'none';
      document.getElementById('ai-result-area').style.display = 'none';

      try {
        const reader = new FileReader();
        reader.readAsDataURL(selFile);
        reader.onloadend = async () => {
          const base64 = reader.result.split(',')[1];
          
          // â˜…â˜…â˜… é«˜å“è³ªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤ºæ–‡ï¼‰ â˜…â˜…â˜…
          const prompt = `
ã‚ãªãŸã¯ç”Ÿå¾’ã«å¤§äººæ°—ã®ã€Œç†±è¡€ã‹ã¤åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ—ãƒ­å®¶åº­æ•™å¸«ã€ã§ã™ã€‚
æ·»ä»˜ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚„å•é¡Œã®ç”»åƒã‚’è§£æã—ã€ä»¥ä¸‹ã®3ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†ã‘ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

**åˆ¶ç´„äº‹é …:**
1. å‡ºåŠ›ã¯å¿…ãšä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Šè¨˜å·ï¼ˆã€ ã€‘ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
2. ç”Ÿå¾’ãŒã‚„ã‚‹æ°—ã«ãªã‚‹ã‚ˆã†ãªã€å„ªã—ãè‚¯å®šçš„ãªå£èª¿ã§æ›¸ã„ã¦ãã ã•ã„ã€‚
3. é›£ã—ã„å°‚é–€ç”¨èªã¯é¿ã‘ã€å°å­¦ç”Ÿï½ä¸­å­¦ç”Ÿã§ã‚‚åˆ†ã‹ã‚‹è¨€è‘‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚

---
ã€è§£èª¬ã€‘
ãƒ»ã¾ãšã€ç­”ãˆã«è‡³ã‚‹ã¾ã§ã®ã€Œè€ƒãˆæ–¹ã®æ‰‹é †ã€ã‚’ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
ãƒ»ãªãœé–“é•ãˆã‚„ã™ã„ã®ã‹ã€ã©ã“ã«æ³¨ç›®ã™ã‚Œã°è§£ã‘ã‚‹ã®ã‹ã®ã€Œã‚³ãƒ„ã€ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
ãƒ»æ•°å¼ã ã‘ã§ãªãã€è¨€è‘‰ã§ã®è£œè¶³ã‚’å……å®Ÿã•ã›ã¦ãã ã•ã„ã€‚

ã€é¡é¡Œã€‘
ãƒ»ç”»åƒã®å•é¡Œã¨åŒã˜å˜å…ƒã€åŒã˜é›£æ˜“åº¦ã®ã€Œã‚ªãƒªã‚¸ãƒŠãƒ«ã®é¡é¡Œã€ã‚’3å•ä½œæˆã—ã¦ãã ã•ã„ã€‚
ãƒ»(1), (2), (3) ã®ã‚ˆã†ã«ç•ªå·ã‚’æŒ¯ã£ã¦ãã ã•ã„ã€‚

ã€é¡é¡Œã®è§£ç­”ã€‘
ãƒ»ä¸Šè¨˜3å•ã®ç­”ãˆã®ã¿ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
---
`;
          
          try {
            const result = await model.generateContent([
              prompt, 
              { inlineData: { data: base64, mimeType: selFile.type } }
            ]);
            const responseText = result.response.text();
            
            // çµæœè¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã™
            renderAIResult(responseText);
            
            loadingEl.style.display = 'none';

          } catch(apiError) {
            console.error(apiError);
            errorEl.innerHTML = "APIã‚¨ãƒ©ãƒ¼: " + apiError.message;
            errorEl.style.display = "block";
            aiBtn.style.display = 'block';
            loadingEl.style.display = 'none';
          }
        }
      } catch(e) {
        errorEl.textContent = "ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼: " + e.message;
        errorEl.style.display = "block";
        loadingEl.style.display = 'none';
        aiBtn.style.display = 'block';
      }
    });

    // â˜…â˜…â˜… AIçµæœè¡¨ç¤º & ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ä¿®æ­£ â˜…â˜…â˜…
    function renderAIResult(text) {
      document.getElementById('ai-result-area').style.display = 'block';
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²
      const parts = text.split('ã€');
      let exp="", sim="", ans="";
      
      parts.forEach(p => {
        if(p.startsWith('è§£èª¬ã€‘')) exp = p.replace('è§£èª¬ã€‘','').trim();
        if(p.startsWith('é¡é¡Œã€‘')) sim = p.replace('é¡é¡Œã€‘','').trim();
        if(p.startsWith('é¡é¡Œã®è§£ç­”ã€‘')) ans = p.replace('é¡é¡Œã®è§£ç­”ã€‘','').trim();
      });

      // è§£èª¬ã‚¨ãƒªã‚¢ã¸ã®æŒ¿å…¥
      const expDiv = document.getElementById('ai-explanation');
      expDiv.innerHTML = exp.replace(/\n/g,'<br>');
      expDiv.classList.remove('open'); // åˆæœŸçŠ¶æ…‹ã¯é–‰ã˜ã‚‹
      
      // ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
      const btn = document.getElementById('btn-exp-toggle');
      if(btn) {
        btn.style.display = 'block';
        btn.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹ â–¼';
        
        // â˜…ä¿®æ­£ç‚¹ï¼šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†ç™»éŒ²
        // (ä»¥å‰ã®onclickãŒæ®‹ã£ã¦ã„ã‚‹ã¨èª¤å‹•ä½œã™ã‚‹ãŸã‚ã€æ–°ã—ã„é–¢æ•°ã§ä¸Šæ›¸ã)
        btn.onclick = function() {
          expDiv.classList.toggle('open');
          if (expDiv.classList.contains('open')) {
            btn.textContent = 'é–‰ã˜ã‚‹ â–²';
          } else {
            btn.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹ â–¼';
          }
        };
      }

      // é¡é¡Œã¨è§£ç­”ã®æŒ¿å…¥
      document.getElementById('ai-similar-problem').innerHTML = sim.replace(/\n/g,'<br>');
      document.getElementById('ai-similar-answer').textContent = ans;
      
      // æ—¥ä»˜
      const now = new Date();
      document.getElementById('print-date').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ä½œæˆ`;
    }

    // PDFä¿å­˜
    document.getElementById('btn-save-pdf').addEventListener('click', ()=>{
      const element = document.getElementById('pdf-content');
      html2pdf().from(element).save();
    });
    
    // æ²ç¤ºæ¿ã¸ã®æŠ•ç¨¿
    document.getElementById('btn-post-exam').addEventListener('click', async()=>{
      if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
      const fullText = document.getElementById('pdf-content').innerText;
      const txt = "ã€AIè§£èª¬ä½œæˆã€‘\n" + fullText;
      
      await addDoc(collection(db,"posts"),{
        schoolId, deptName, text:txt, type:'exam_result', userId:currentUser.uid, userName:currentUser.displayName||"AI User", createdAt:serverTimestamp()
      });
      alert("æŠ•ç¨¿ã—ã¾ã—ãŸ");
    });

  }); 

  function escapeHtml(s) { return s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):""; }
</script>
</body>
</html>